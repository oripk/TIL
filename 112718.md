# 스텔스 프로세스
Rootkit이라는 메모리, 프로세스, 파일 등을 은페하는 기법 중에 하나로 프로세스를 은폐 하는 것에 관한 것이다.

은폐를 하기 위해서 프로세스를 바꾸는 것이 아니라 탐지하는 프로그램들을 모두 고장나게 해버린다.
현실에서는 전투기를 탐지 하지 못하게 하기 위해 전투기에 특별한 처리 혹은 기구를 장착하는 것이 아니라, 전투기를 탐지하는 모든 레이더를 고장내는 식이다.

코드 인젝션기법을 통해 레이더 기능을 하는 함수를 후킹하여, 프로세스를 탐지하는 프로세스가 고장나게 만든다.

## 코드 인젝션 기법이란?
프로그램을 더블 클릭해서 실행시킬때, 수 많은 일이 일어나게 된다.
램이나 하드디스크등을 관리하는 역할인 운영체제는 프로그램이 실행됨을 인지하고 해당 프로그램을 실행시키기 위해 
램에 자리를 마련하게 된다. 왜냐하면 프로그램은 코드로 작성되어있는데 이를 컴퓨터가 이해하기 위해 좀 더 접근 속도가 빠른 램에 올림으로서 프로그램의 작동시간이 현저히 줄어들기 때문이다. 뿐만 아니라 다른 다양한 이유 때문에 램에 자리를 마련하게 된다. 마련된 자리에는 코드 영역, 데이터 영역 등의 영역으로 구분되어진다. 마이크로소프트 사에서는 프로그램을 업데이트하기 위한 장치로 어떤 프로그램이 다른 프로그램의 램 영역에 접근할 수 있는 도구를 만들어 두었는데, 이를 이용하면 다른 프로그램의 코드 영역에 접근하여 다른 프로그램을 원하는대로 작동시킬 수 있다. 이러한 도구를 이용하여, 레이더 기능을 하는 프로그램을 무력화 하는 것이다.

## 글로벌 후킹
글로벌 후킹은 스텔스 프로세스를 진행할 때, 현재 실행되고 있는 프로세스에 대해서만 고장이 난다는 특징이 있었다. 만약 사용자가 탐지 프로그램 예를 들어, 작업관리자가 실행된 상태에서 후킹을 하고 이후에 또 다른 작업관리자가 실행된다면 이후 실행된 작업관리자는 탐지를 아주 잘하게 된다. 
가령 스텔스 전투기를 만드려 이 세상에 존재하는 모든 레이더를 겨우 고장냈는데 신제품이 나온 것이다. 이럴 때는 레이더의 핵심 부품 몇개를 선정하여 해당 부품에 대해서만 고장내면된다. 즉, 만드는 족족 다 고장내버리는 것이다.

프로세스를 실행할 때, CreateProcess()API가 사용되게 된다. 따라서 이 API와 관련된 함수를 후킹하게 되면 저 API가 실행되는 시점, 즉, 프로세스가 실행되는 시점에서 우리가 원하는 코드를 주입할 수 있다. 

## 핫 패치(7바이트 코드 패치)
기존에는 5바이트 코드만을 패치했다. 5바이트 코드로 JMP [주소]를 사용했는데 이는 런타임 에러나, 성능저하라는 단점이 존재한다. 시스템의 주요 라이브러리들은 메소드 앞에 7바이트의 불필요한 공간이 존재한다. 이는 마이크로소프트사도 이 핫 패치 방식을 이용하기 위함이었다. 핫 패치 방식으로 프로세스를 은폐하다보면, 성능저하의 원인인 훅/언훅 과정이 불필요해진다. 왜냐하면 기존 코드를 실행시키고 싶다면 주소로 분기할 수 있기 때문이다. 실제 메소드를 실행시키고 싶으면 메소드 시작 주소에 7을 더한 곳으로 점프 시키면 되고, 후킹된 메소드를 실행시키고 싶으면 실제 메소드의 시작 주소로 점프하면 되기 때문이다. 

## 핫 패치 방식의 API 후킹에서 고려사항
핫 패치 방식이 좋기는 하지만 만능해결사는 아니다. 왜냐하면 말그대로 모든 API가 전부 시작주소로부터 7바이트를 의미 없는 값을 안 둘 수도 있기 때문이다. 